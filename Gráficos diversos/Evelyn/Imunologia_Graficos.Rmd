---
output: 
  html_document: 
    toc: yes
---





# Importar de bibliotecas
```{r}
library(tidyverse)
library(rstatix)
library(ggsci)
library(here)
library(paletteer)
library(ggpubr)
library(readxl)
library(janitor)
library(patchwork)
library(ggforce)
library(lme4)
library(lmeTest) # Adiciona p-values ao lme4
library(emmeans)
library(ssize.fdr)
library(ggh4x)
# install.packages("paletteer")
```


# Design do estudo

Cohen's d Tamanho de efeito:
0.2: Pequeno (diferen√ßa sutil, mas observ√°vel).
0.5: M√©dio (diferen√ßa moderada, percept√≠vel a olho nu).
0.8 ou maior: Grande (diferen√ßa significativa).
Exemplo pr√°tico:
d=0.2: Diferen√ßa de peso entre pessoas de 150 cm e 152 cm de altura.
d=0.8: Diferen√ßa de peso entre pessoas de 150 cm e 165 cm.

Teste T
```{r}
# install.packages("pwr")
library(pwr)

# TESTE T ------

# Calcular poder estat√≠stico
pwr.t.test(
  d = 0.8,           # Tamanho do efeito
  n = 12,          
  sig.level = 0.05, 
  type = "two.sample", 
  alternative = "two.sided" # Teste bilateral
)


# Calcular tamanho da amostra
pwr.t.test(
  d = 1,           # Tamanho do efeito
  power = 0.8,       # Poder desejado
  sig.level = 0.05,  # N√≠vel de signific√¢ncia
  type = "two.sample"  # Teste de duas amostras
)



# Par√¢metros
mean_diff <- 1    # Diferen√ßa esperada entre os grupos
sd1 <- 2          # Desvio padr√£o do grupo 1
sd2 <- 1          # Desvio padr√£o do grupo 2
power <- 0.8      # Poder desejado
alpha <- 0.05     # N√≠vel de signific√¢ncia

```

ANOVA
```{r}
# ANOVA -----
# Calcular o poder
pwr.anova.test(
  k = 3,           # Grupos
  n = 10,          # Tamanho da amostra por grupo
  f = 0.25,        # Effect size (pequeno = 0.1, m√©dio = 0.25, grande = 0.4)
  sig.level = 0.05 # N√≠vel de signific√¢ncia
)

# Calcular tamanho de amostra
pwr.anova.test(
  k = 3,            # Grupos 
  power = 0.5,      # Poder
  f = 0.4,        # Effect size (pequeno = 0.1, m√©dio = 0.25, grande = 0.4)
  sig.level = 0.05 # N√≠vel de signific√¢ncia
)

```



# Citometria
```{r}
#Importar
citometria_dezembro <- read_excel(here("Gr√°ficos diversos", "Evelyn", "citometria_evelyn_29-12-25.xlsx"))

#Padronizar tabela
#Pivotar para formato longo
citometria_clean = citometria_dezembro %>% 
  #Retirar linha de animal, para add depois
  filter(Marcador != "Animal") %>% 
  pivot_longer(cols = -c("Teste", "Marcador"),
               names_to = "Condicao",
               values_to = "valor") %>% 
  clean_names() %>% 
  #Add animais
  group_by(teste, marcador) %>%
  mutate(animal_id = paste0("M.", row_number())) %>%
  ungroup() %>% 
  #padronizar
  mutate(#substituir virgula por ponto  
         valor = str_replace(valor, ",", ".") %>% 
           str_replace(", ", ".") %>% 
           str_replace(". ", ".") %>% 
           as.numeric(),
         condicao = str_replace(condicao, "\\.{3}\\d+", ""), #Retirar "...numero"
         condicao = str_replace(condicao, "Vacina ", "Vac "), #Retirar "Vacina "
         condicao = str_replace(condicao, "ug", "Œºg"), #Trocar unidade
         condicao = str_replace(condicao, " Œºg", "Œºg"), #Trocar unidade
         #Definir grupos, sem a dose
         grupo = case_when(str_detect(condicao, "Vac") ~ "Vac",
                           str_detect(condicao, "PBS") ~ "PBS",
                           str_detect(condicao, "QB") ~ "QB",
                           str_detect(condicao, "ED-III") ~ "ED-III",
                           str_detect(condicao, "Alum") ~ "Alum",
                           T ~ condicao),
         #Extrair e reordenar dose
         dose = str_remove_all(condicao, "Alum |PBS |Vac |ED-III "),
         #Reordenar fatores
         dose = fct_relevel(dose, 
                             "PBS",
                             "ED-III",
                              "QB",
                             "10Œºg",
                             "25Œºg",
                             "50Œºg"),
         #Reordenar grupo
         grupo = fct_relevel(grupo, 
                             "PBS",
                             "ED-III",
                             "QB",
                             "Vac",
                             "Alum")

         ) %>% 
  group_by(teste, marcador, grupo) %>%
  mutate(animal_id = paste0("M.", row_number())) %>%
  #Add summary statistics
  group_by(teste, marcador, grupo, dose) %>% 
  mutate(n = n()) %>% 
  ungroup() %>% 
  mutate(grupo_n = paste0(condicao, " n=", n),
         dose_n = paste0(dose, "\nn=", n),
         experimento = "1-2-3") %>% 
  arrange(grupo, dose) %>% 
  mutate(dose_n = fct_inorder(dose_n))

citometria_clean

citometria_clean %>% 
  write_csv(file = here("Gr√°ficos diversos", "Evelyn", "citometria_clean.csv"))

```
## Distribui√ß√µes
```{r fig.height=8, fig.width=10}

citometria_clean = 
  read_csv(file = here("Gr√°ficos diversos", "Evelyn", "citometria_clean.csv"))

#Identificar outliers
citometria_clean %>% 
  group_by(grupo, teste, marcador) %>% 
  identify_outliers(valor) 


#Variancias s√£o iguais (homosquedacidade)?
citometria_clean %>% 
  group_by(teste, marcador) %>% 
  levene_test(valor ~ grupo) %>% 
  mutate(homo = ifelse(p > 0.05, "Yes", "No"))
  


citometria_clean_boxplots = citometria_clean %>% 
  ggplot() +
  aes(x = interaction(dose_n, grupo),
      y = valor,
      fill = grupo) +
  facet_grid(~marcador~teste, 
             space = "free_x",
             scales = "free",
             axis.labels = "all_y",
             axes = "all") +
  geom_boxplot(
      outlier.shape = NA,
      width = 0.5,
      alpha = 1) +
  # Para Intervalo de Confian√ßa de 95% (Distribui√ß√£o t)
  # stat_summary(geom = "crossbar", fun.data = mean_cl_normal, position = "dodge", width=.2)+
  geom_sina(size = 1.5,
             stroke = 1,
             pch = 1,
             alpha = 1) +
  theme_minimal() +
  labs(title = "Distribui√ß√£o dos Valores por Grupo, Citometria",
       x = "",
       y = "Absorbancia",
       fill = "Grupos",
       color = "Experimento") +
    theme(text = element_text(size = 10,
                            color = "black"),
        plot.caption = element_text(size = 10, 
                                    color = "black",
                                    hjust = 0.5),
        legend.position = "top",
        legend.margin=margin(0,0,0,0),
          legend.box.margin=margin(0,0,-10,0),
          legend.text = element_text(size = 10, hjust = 0),
          legend.title = element_text(size = 10),
        axis.text.x = element_text(
          # angle = 45,
                                   size = 10,
                                   # hjust = 1,
                                   # vjust = 1,
                                   color = "black"),
        axis.text.y = element_text(size = 10,
                                   color = "black"),
        strip.text = element_text(size = 10,
                                  color = "black"),
        strip.text.y = element_text(size = 10,
                                  color = "black",
                                  angle = 0),
        axis.line = element_line(color = "black",
                                   size = 1),
        axis.ticks.x = element_line(color = "black",
                                  size = 1),
        panel.grid = element_line(linetype = 2,
                                  color = "gray90"),
        ggh4x.axis.nestline = element_line(linetype =1)) +
  scale_fill_manual(values = c("PBS" = "white",
                             "ED-III" = "#9f9fed",
                             "QB" = "#adf7b6",
                             "Vac" = "#a9def9",
                             "Alum" = "#ff5d8f"))+
  guides(fill = guide_legend(nrow = 1),
    x = "axis_nested", 
    fill = "legend_group")

citometria_clean_boxplots
citometria_clean_boxplots %>%
ggsave(filename = here("Gr√°ficos diversos", "Evelyn", "Citometria_CD4_CD8.png"),
       width = 10,
       height = 8,
       bg = "white")

```



## Teste de normalidade
```{r fig.height=10, fig.width=10}
#Teste de Shapiro-Wilk
## p<0.05: N√£o-normal
## p>0.05: Normal
citometria_clean %>% 
  group_by(grupo, teste, marcador) %>% 
  shapiro_test(valor) %>% 
  mutate(normal = ifelse(p > 0.05, "Yes", "No"))


# Q-Q Plot
qq_plot = citometria_clean %>% 
ggplot(aes(sample = valor,
           color = grupo)) +
  scale_x_continuous(expand = c(0.1,0.1), 
                     n.breaks = 3
                     ) +  
  scale_y_continuous(expand = c(0.1,0.1), 
                     n.breaks = 3
                     ) + 
  stat_qq() +
  stat_qq_line() +
  facet_grid(~condicao~teste+marcador, 
               scales = "free",
             axes = "all",
             axis.labels = "margins") +
  theme_minimal() +
   scale_color_manual(values = c("PBS" = "gray90",
                             "ED-III" = "#9f9fed",
                             "QB" = "#adf7b6",
                             "Vac" = "#a9def9",
                             "Alum" = "#ff5d8f"))+
    theme(text = element_text(size = 10,
                            color = "black"),
        plot.caption = element_text(size = 10, 
                                    color = "black",
                                    hjust = 0.5),
        legend.position = "none",
        panel.spacing.x = unit(0, "lines"),
        plot.margin = margin(0, 0.3, 0, 0, unit = "cm"),
        axis.text.x = element_text(angle = 0,
                                   size = 10,
                                   color = "black"),
        axis.text.y = element_text(size = 10,
                                   color = "black"),
        strip.text = element_text(size = 10,
                                  color = "black"),
        strip.text.y = element_text(size = 10, hjust = 0, vjust = 0.5, angle = 0),
        axis.line = element_line(color = "black",
                                   size = 0.5),
        axis.ticks = element_line(color = "black",
                                  size = 0.5),
        panel.grid = element_line(linetype = 2,
                                  color = "gray90"),
        ggh4x.facet.nestline = element_line(colour = "black", linetype = 1)) +
  labs(x = "",
       y = "",
       title = "Q-Q Plot - Teste de normalidade")



qq_plot

qq_plot %>%
ggsave(filename = here("Gr√°ficos diversos", "Evelyn", "Citometria_qqplot.png"),
       width = 10,
       height = 10,
       bg = "white")


```


## ANOVA e posthoc

```{r fig.height=7, fig.width=10}
#ANOVA de Welch
anova.res <- citometria_clean %>%
  group_by(teste, marcador) %>%
  welch_anova_test(valor ~ grupo_n)

anova.res
```

cd4
```{r fig.height=8, fig.width=12}

# 1. Prepara√ß√£o da tabela de estat√≠stica
stat.test_cd4 <- citometria_clean %>%
  filter(teste == "CD4") %>% 
  group_by(marcador) %>%
  games_howell_test(valor ~ grupo_n) %>% 
  mutate(
    p.adj.signif = case_when(
      p.adj <= 0.001 ~ "***",
      p.adj <= 0.01  ~ "**",
      p.adj <= 0.05  ~ "*",
      TRUE           ~ "ns")) %>% 
  group_by(marcador) %>%
  add_xy_position(x = "grupo_n", step.increase = 0, scales = "free") %>% 
  ungroup()

# 2. Calcular Effect Size 
effect_size_cd4 <- citometria_clean %>%
  filter(teste == "CD4") %>% 
  group_by(marcador) %>%
  cohens_d(valor ~ grupo_n, var.equal = FALSE) %>% 
  mutate(effsize = round(effsize, 1))

# Join final
stat.test_cd4_final <- stat.test_cd4 %>% 
  inner_join(effect_size_cd4, by = c("marcador", "group1", "group2")) 

#PLOT
citometria_plot_CD4 = citometria_clean %>%
  filter(teste == "CD4") %>%
  mutate(grupo_n = str_replace_all(grupo_n, " ", "\n")) %>% 
  arrange(grupo, dose) %>% 
  mutate(grupo_n = fct_inorder(grupo_n)) %>% 
  ggplot() +
  aes(x = grupo_n,
      y = valor) +
  # geom_boxplot(
  #   aes(fill = grupo),
  #     outlier.shape = NA, 
  #     width = 0.8,
  #     alpha = 1) +
  facet_nested_wrap(~teste+marcador, 
                    scales = "free",
             axes = "all",
             ) +
  stat_summary(aes(fill = grupo),
               geom = "crossbar", fun.data = mean_cl_normal, position = "dodge", width=.2)+
  stat_summary(fun.y= mean, 
               geom="point", 
               shape=95, 
               size=5, 
               color="black",
               stroke = 5,
               alpha = 1,
               show.legend = F) +
    geom_sina(color = "black",
              size = 1.5, #or geom_jitter(position = position_dodge(width = 0.1))
             stroke = 1,
             pch = 1,
             alpha = 1) +
  theme_minimal() +
  theme(text = element_text(size = 10,
                            color = "black"),
        plot.caption = element_text(size = 10, 
                                    color = "black",
                                    hjust = 0.5),
        legend.position = "top",
        legend.margin=margin(0,0,0,0),
          legend.box.margin=margin(0,0,-10,0),
          legend.text = element_text(size = 10, hjust = 0),
          legend.title = element_text(size = 10),
        axis.text.x = element_text(size = 10,
                                   hjust = 0.5,
                                   color = "black"),
        axis.text.y = element_text(size = 10,
                                   color = "black"),
        strip.text = element_text(size = 10,
                                  color = "black"),
        strip.text.y = element_text(size = 10,
                                  color = "black",
                                  angle = 0),
        axis.line.x = element_line(color = "black",
                                   size = 1),
        ggh4x.axis.nestline = element_line(linetype =1), 
        ggh4x.facet.nestline = element_line(colour = "black", linetype = 1),
        axis.line.y = element_line(color = "black",
                                   size = 1),
        axis.ticks.x = element_line(color = "black",
                                  size = 1),
        panel.grid = element_line(linetype = 2,
                                  color = "gray90")) +
  stat_pvalue_manual(data = stat.test_cd4_final,
    label = "p.adj.signif", 
    hide.ns = TRUE, 
    bracket.size = 0.3, 
    tip.length = 0.0,
    step.increase = 0.05,
  ) +
   scale_fill_manual(values = c("PBS" = "white",
                             "ED-III" = "#9f9fed",
                             "QB" = "#adf7b6",
                             "Vac" = "#a9def9",
                             "Alum" = "#ff5d8f"))+
    labs(fill = "Grupo",
       x = "",
       y = "MFI",
       title = "Citometria - CD4 - All vs. All",
       subtitle =  "Welch's ANOVA, Games-Howell post-hoc test. \nSignificance p-value symbols: * = 0.10, ** = 0.05, *** = < 0.01. Red lines correspond to the mean.",
       # caption = get_pwc_label(stat.test_cd4_final)
       ) 

citometria_plot_CD4


# citometria_plot_CD4 %>%
# ggsave(filename = here("Gr√°ficos diversos", "Citometria_AllvsAll_Welch_GamesHowell_CD4_CD8.png"),
#        width = 10,
#        height = 10,
#        bg = "white")


```
CD8
```{r fig.height=8, fig.width=10}

# 1. Prepara√ß√£o da tabela de estat√≠stica
stat.test_CD8 <- citometria_clean %>%
  filter(teste == "CD8") %>% 
  group_by(marcador) %>%
  games_howell_test(valor ~ grupo_n) %>% 
  mutate(
    p.adj.signif = case_when(
      p.adj <= 0.001 ~ "***",
      p.adj <= 0.01  ~ "**",
      p.adj <= 0.05  ~ "*",
      TRUE           ~ "ns")) %>% 
  group_by(marcador) %>%
  add_xy_position(x = "grupo_n", step.increase = 0, scales = "free") %>% 
  ungroup()

# 2. Calcular Effect Size 
effect_size_CD8 <- citometria_clean %>%
  filter(teste == "CD8") %>% 
  group_by(marcador) %>%
  cohens_d(valor ~ grupo_n, var.equal = FALSE) %>% 
  mutate(effsize = round(effsize, 1))

# Join final
stat.test_CD8_final <- stat.test_CD8 %>% 
  inner_join(effect_size_CD8, by = c("marcador", "group1", "group2")) 

#PLOT
citometria_plot_CD8 = citometria_clean %>%
  filter(teste == "CD8") %>%
  mutate(grupo_n = str_replace_all(grupo_n, " ", "\n")) %>% 
  arrange(grupo, dose) %>% 
  mutate(grupo_n = fct_inorder(grupo_n)) %>% 
  ggplot() +
  aes(x = grupo_n,
      y = valor) +
  # geom_boxplot(
  #   aes(fill = grupo),
  #     outlier.shape = NA, 
  #     width = 0.8,
  #     alpha = 1) +
  facet_nested_wrap(~teste+marcador, 
                    scales = "free",
             axes = "all",
             ) +
  stat_summary(aes(fill = grupo),
               geom = "crossbar", fun.data = mean_cl_normal, position = "dodge", width=.2)+
  stat_summary(fun.y= mean, 
               geom="point", 
               shape=95, 
               size=5, 
               color="black",
               stroke = 5,
               alpha = 1) +
    geom_sina(color = "black",
              size = 1.5, #or geom_jitter(position = position_dodge(width = 0.1))
             stroke = 1,
             pch = 1,
             alpha = 1) +
  theme_minimal() +
    theme(text = element_text(size = 10,
                            color = "black"),
        plot.caption = element_text(size = 10, 
                                    color = "black",
                                    hjust = 0.5),
        legend.position = "top",
        legend.margin=margin(0,0,0,0),
          legend.box.margin=margin(0,0,-10,0),
          legend.text = element_text(size = 10, hjust = 0),
          legend.title = element_text(size = 10),
        axis.text.x = element_text(size = 10,
                                   hjust = 0.5,
                                   color = "black"),
        axis.text.y = element_text(size = 10,
                                   color = "black"),
        strip.text = element_text(size = 10,
                                  color = "black"),
        strip.text.y = element_text(size = 10,
                                  color = "black",
                                  angle = 0),
        axis.line.x = element_line(color = "black",
                                   size = 1),
        ggh4x.axis.nestline = element_line(linetype =1), 
        ggh4x.facet.nestline = element_line(colour = "black", linetype = 1),
        axis.line.y = element_line(color = "black",
                                   size = 1),
        axis.ticks.x = element_line(color = "black",
                                  size = 1),
        panel.grid = element_line(linetype = 2,
                                  color = "gray90")) +
  stat_pvalue_manual(data = stat.test_CD8_final,
    label = "p.adj.signif", 
    hide.ns = TRUE, 
    bracket.size = 0.3, 
    tip.length = 0.0,
    step.increase = 0.05,
  ) +
   scale_fill_manual(values = c("PBS" = "white",
                             "ED-III" = "#9f9fed",
                             "QB" = "#adf7b6",
                             "Vac" = "#a9def9",
                             "Alum" = "#ff5d8f"))+
    labs(fill = "Grupo",
       x = "",
       y = "MFI",
       title = "Citometria - All vs. All",
       subtitle =  "Welch's ANOVA, Games-Howell post-hoc test. \nSignificance p-value symbols: * = 0.10, ** = 0.05, *** = < 0.01. Red lines correspond to the mean.",
       # caption = get_pwc_label(stat.test_CD8_final)
       ) 

citometria_plot_CD8


```


```{r fig.height=12, fig.width=12}
citometria_plot_CD4_CD8_test = ((citometria_plot_CD4 + theme(plot.title = element_blank(),
                              plot.subtitle = element_blank())) / plot_spacer() /
   (citometria_plot_CD8 + theme(plot.title = element_blank(),
                                plot.subtitle = element_blank()))) +
  plot_layout(guides = "collect", axes = "collect",
              heights = c(1, -0.10, 1)) +
  plot_annotation(
    theme = theme(
      legend.position = "top",
      legend.margin = margin(0, 0, 0, 0),
      legend.box.margin = margin(0, 0, -10, 0),
      legend.text = element_text(size = 10, hjust = 0),
      legend.title = element_text(size = 10),
      panel.spacing = unit(0, "lines"),
      plot.margin = margin(0, 0, 0, 0, unit = "cm"),
      plot.title = element_text(hjust = 0, margin = margin(l = 30,
                                                           b = -10)),
      plot.subtitle = element_text(hjust = 0, margin = margin(l = 30))
    ),
    title = "Citometria - All vs. All\n",
    subtitle = "Welch's ANOVA, Games-Howell post-hoc test. \nSignificance p-value symbols: * = 0.10, ** = 0.05, *** = < 0.01.\nBlack thick lines correspond to the mean."
  )

citometria_plot_CD4_CD8_test

citometria_plot_CD4_CD8_test %>%
ggsave(filename = here("Gr√°ficos diversos", "Evelyn", "Citometria_AllvsAll_Welch_GamesHowell_CD4_CD8.png"),
       width = 12,
       height = 10,
       bg = "white")

```









# ELISA OD50
```{r fig.height=5, fig.width=10}
ELISA_OD50 <- read_excel(here("Gr√°ficos diversos", "Evelyn", "ELISA_OD50.xlsx"))

table = ELISA_OD50 %>% 
  filter(dia != "Animal") %>% 
  pivot_longer(cols = -dia,
               values_to = "valor",
               names_to = "condicao") %>% 
  mutate(teste = "ELISA OD50") %>% 
  group_by(teste, dia) %>%
  separate(condicao, into = c("condicao", "del"), "\\...") %>% 
  select(-del) %>% 
  mutate(animal_id = paste0("M.", row_number())) %>% 
  ungroup() %>% 
  mutate(dia = as.factor(dia),
         #substituir virgula por ponto  
         valor = str_replace(valor, ",", ".") %>% 
           str_replace(", ", ".") %>% 
           str_replace(". ", ".") %>% 
           as.numeric(),
         valor_log = log10(valor + 1),
         
         condicao = str_replace(condicao, "ug", "Œºg"), #Trocar unidade
         condicao = str_replace(condicao, " Œºg", "Œºg"), #Trocar unidade
         ) %>% 
  mutate(condicao = str_replace(condicao, pattern = "Vacina Alum ", "Alum "),
         condicao = str_replace(condicao, pattern = "Vacina ", "Vac "),
         condicao = str_remove(condicao, pattern = "Prote√≠na "),
         #Definir grupos, sem a dose
         grupo = case_when(str_detect(condicao, "Vac") ~ "Vac",
                           str_detect(condicao, "PBS") ~ "PBS",
                           str_detect(condicao, "QB") ~ "QB",
                           str_detect(condicao, "ED-III") ~ "ED-III",
                           str_detect(condicao, "Alum") ~ "Alum",
                           T ~ condicao),
         grupo = fct_relevel(grupo, 
                             "PBS", 
                             "QB",
                             "ED-III",
                             "Vac",
                             "Alum"
                             ),
         #Extrair e reordenar dose
         dose = str_remove_all(condicao, "Alum |PBS |Vac |ED-III "),
         #Reordenar fatores
         dose = fct_relevel(dose, 
                             "PBS",
                              "QB",
                             "10Œºg",
                             "25Œºg",
                             "50Œºg")) %>% 
  #Add summary statistics
  group_by(teste, dia, grupo, dose) %>% 
  mutate(n = n()) %>% 
  ungroup() %>% 
  mutate(grupo_n = paste0(condicao, " n=", n),
         dose_n = paste0(dose, "\nn=", n),
         experimento = "1-2-3") %>% 
  arrange(grupo, dose) %>% 
  mutate(dose_n = fct_inorder(dose_n))

table

```





## ANOVA e posthoc
### Teste de normalidade
```{r fig.height=5, fig.width=5}
#Teste de Shapiro-Wilk
## p<0.05: N√£o-normal
## p>0.05: Normal
table %>% 
  filter(!grupo %in% c("QB", "PBS")) %>% 
  group_by(grupo) %>% 
  shapiro_test(valor_log) %>% 
  mutate(normal = ifelse(p > 0.05, "Yes", "No"))


# Q-Q Plot
qq_plot = table %>% 
  arrange(grupo_n) %>% 
  mutate(condicao = fct_inorder(condicao)) %>% 
ggplot(aes(sample = valor_log,
           color = grupo)) +
  scale_x_continuous(expand = c(0.1,0.1), 
                     n.breaks = 3
                     ) +  
  scale_y_continuous(expand = c(0.1,0.1), 
                     n.breaks = 3
                     ) + 
  stat_qq() +
  stat_qq_line() +
  facet_grid(~condicao~dia, 
               scales = "free",
             axes = "all",
             axis.labels = "margins") +
  theme_minimal() +
  scale_color_manual(values = c("PBS" = "white",
                             "ED-III" = "#9f9fed",
                             "QB" = "#adf7b6",
                             "Vac" = "#a9def9",
                             "Alum" = "#ff5d8f"))+
    theme(text = element_text(size = 10,
                            color = "black"),
        plot.caption = element_text(size = 10, 
                                    color = "black",
                                    hjust = 0.5),
        legend.position = "none",
        panel.spacing.x = unit(0, "lines"),
        plot.margin = margin(0, 0.3, 0, 0, unit = "cm"),
        axis.text.x = element_text(angle = 0,
                                   size = 10,
                                   color = "black"),
        axis.text.y = element_text(size = 10,
                                   color = "black"),
        strip.text = element_text(size = 10,
                                  color = "black"),
        strip.text.y = element_text(size = 10, hjust = 0, vjust = 0.5, angle = 0),
        axis.line = element_line(color = "black",
                                   size = 0.5),
        axis.ticks = element_line(color = "black",
                                  size = 0.5),
        panel.grid = element_line(linetype = 2,
                                  color = "gray90"),
        ggh4x.facet.nestline = element_line(colour = "black", linetype = 1)) +
  labs(x = "",
       y = "",
       title = "Q-Q Plot - Teste de normalidade")



qq_plot

qq_plot %>%
ggsave(filename = here("Gr√°ficos diversos", "Evelyn", "ELISA_OD50_qqplot.png"),
       width = 5,
       height = 5,
       bg = "white")


```
### Por dia

#### Teste de diferen√ßas
```{r fig.height=8, fig.width=12}
library(rstatix) 
anova_summary <- table %>%
 filter(!grupo %in% c("QB", "PBS")) %>% 
  group_by(dia, dose) %>%
  welch_anova_test(valor_log ~ grupo_n)

stat.test_dia = table %>% 
  filter(!grupo %in% c("QB", "PBS")) %>%
    mutate(grupo_n = str_replace_all(grupo_n, " ", "\n"),
         grupo_n = str_replace_all(grupo_n, " ", "\n"),) %>% 
  group_by(dia) %>%
  games_howell_test(valor_log ~ grupo_n, 
            detailed = T) %>% 
  group_by(dia) %>%
  add_xy_position(x = "grupo_n", step.increase = 0, scales = "free_y") %>% 
  ungroup() %>% 
  mutate(p.adj.signif = case_when(
      p.adj <= 0.01 ~ "***",       # p <= 0.01
      p.adj <= 0.05 ~ "**",        # 0.01 < p <= 0.05
      p.adj <= 0.10 ~ "*",         # 0.05 < p <= 0.10
      TRUE ~ "ns"                        # p > 0.10
    )
  ) %>% 
  group_by(dia) %>% 
  mutate(
    xmin = group1,
    xmax = group2,
    y.position = max(table$valor_log, na.rm = TRUE) + 0.2 ) %>%
  ungroup() 
    # filter(!p.adj.signif %in% c("ns")) %>% 
    # mutate(y.position = min(y.position) + (row_number() - 1) * 0.1) 


# 2. Calcular Effect Size 
effect_size <- table %>%
  filter(!grupo %in% c("QB", "PBS")) %>% 
    mutate(grupo_n = str_replace_all(grupo_n, " ", "\n"),
         grupo_n = str_replace_all(grupo_n, " ", "\n"),) %>% 
  group_by(dia) %>%
  cohens_d(valor_log ~ grupo_n, var.equal = FALSE) %>% 
  mutate(effsize = round(effsize, 1))

# Join final
stat.test<- stat.test_dia %>% 
  inner_join(effect_size, by = c("dia", "group1", "group2"))
```


```{r fig.height=8, fig.width=12}
plot = table %>% 
  mutate(grupo_n = str_replace_all(grupo_n, " ", "\n")) %>% 
  arrange(grupo, dose) %>% 
  mutate(grupo_n = fct_inorder(grupo_n)) %>% 
  ggplot() +
  aes(x = grupo_n,
      y = valor_log) +
    facet_grid(~paste("Dia", dia),
             space = "free_x",
             scales = "free_x",
             axes = "all",
             ) +
  stat_summary(aes(fill = grupo),
               geom = "crossbar", fun.data = mean_cl_normal, position = "dodge", width=.2)+
  stat_summary(fun.y= mean, 
               geom="point", 
               shape=95, 
               size=3, 
               color="red",
               stroke = 5,
               # fill="red", 
               alpha = 1,
               show.legend = F) +
  stat_summary(fun.y= mean, 
               geom="point", 
               shape=95, 
               size=5, 
               color="black",
               stroke = 5,
               alpha = 1,
               show.legend = F) +
  geom_sina(color = "black",
              size = 1.5, #or geom_jitter(position = position_dodge(width = 0.1))
             stroke = 1,
             pch = 1,
             alpha = 1) +
  stat_pvalue_manual(data = stat.test,
    label = "p.adj.signif", 
    hide.ns = TRUE, 
    bracket.size = 0.3, 
    tip.length = 0.0,
    step.increase = 0.05,
    # vjust = 0.7
  ) +

# geom_violin(color = "gray10",
  #             fill = NA,
  #             alpha = 1, 
  #             width = 1) +
  # geom_boxplot(outlier.shape = NA,
  #              alpha = 1, 
  #              width = 0.5) +
  
  theme_minimal() +
  theme(text = element_text(size = 10,
                            color = "black"),
        plot.caption = element_text(size = 10, 
                                    color = "black",
                                    hjust = 0.5),
        legend.position = "top",
        legend.margin=margin(0,0,0,0),
          legend.box.margin=margin(0,0,-10,0),
          legend.text = element_text(size = 10, hjust = 0),
          legend.title = element_text(size = 10),
        axis.text.x = element_text(size = 10,
                                   hjust = 0.5,
                                   color = "black"),
        axis.text.y = element_text(size = 10,
                                   color = "black"),
        strip.text = element_text(size = 10,
                                  color = "black"),
        strip.text.y = element_text(size = 10,
                                  color = "black",
                                  angle = 0),
        axis.line.x = element_line(color = "black",
                                   size = 1),
        ggh4x.axis.nestline = element_line(linetype =1), 
        ggh4x.facet.nestline = element_line(colour = "black", linetype = 1),
        axis.line.y = element_line(color = "black",
                                   size = 1),
        axis.ticks.x = element_line(color = "black",
                                  size = 1),
        panel.grid = element_line(linetype = 2,
                                  color = "gray90")) +
  
  # # scale_y_continuous(transform = "log10", 
  # #                    labels = scales::label_log(base = 10),
  # #                    breaks = scales::breaks_log(n = 6)) +
  # annotation_logticks(sides = "l") +
  scale_fill_manual(values = c("PBS" = "white",
                             "ED-III" = "#9f9fed",
                             "QB" = "#adf7b6",
                             "Vac" = "#a9def9",
                             "Alum" = "#ff5d8f"))+
    labs(fill = "Grupo",
       color = "Grupo",
       x = "",
       y = "OD50",
       title = "ELISA OD50% - All vs. All ",
       subtitle =  "Kruskal-Wallis test (Benjamini-Hochberg correction). \nSignificance p-value symbols: * = 0.10, ** = 0.05, *** = < 0.01. Black lines correspond to the mean.") 

plot

```

### Por grupo


#### Teste de diferen√ßas
```{r fig.height=4, fig.width=10}

 table

```


```{r fig.height=4, fig.width=10}
library(rstatix) 
library(lme4)
library(emmeans)
modelo <- lmer(valor_log ~ grupo_n * dia + (1|animal_id), 
               data = table %>% 
                 filter(!grupo %in% c("QB", "PBS")))


anova_summary <- 
  anova(modelo)

# Comparar dias dentro de cada grupo
post_hoc <- emmeans(modelo, pairwise ~ dia | grupo_n, adjust = "tukey")


# Transformar em uma tabela formatada (estilo rstatix)
stat.test_misto <- as_tibble(post_hoc$contrasts) %>%
  # Limpa o nome do dia se ele vier como "dia 14"
  mutate(contrast = str_remove_all(contrast, "dia")) %>% 
  separate(contrast, into = c("group1", "group2"), sep = " - ") %>%
  mutate(grupo_n = str_replace_all(grupo_n, " ", "\n")) %>%
  mutate(
    p.adj.signif = case_when(
      p.value <= 0.001 ~ "***",
      p.value <= 0.01  ~ "**",
      p.value <= 0.05  ~ "*",
      TRUE             ~ "ns"
    )
  ) %>%
  # Importante: para stat_pvalue_manual, xmin e xmax devem ser as categorias do eixo X (dia)
  mutate(
    xmin = group1,
    xmax = group2,
    y.position = max(table$valor_log, na.rm = TRUE) + 0.2
  ) %>%
  filter(p.adj.signif != "ns") %>% 
  mutate(
    y.position = max(table$valor_log, na.rm = TRUE) +
                 0.2 + 0.15 * row_number()
  ) 

stat.test_misto


# Calcular Effect Size 
effect_size <- table %>%
  group_by(grupo_n) %>%
  filter(!grupo %in% c("QB", "PBS")) %>% 
  cohens_d(valor_log ~ dia, var.equal = FALSE) %>% 
  mutate(effsize = round(effsize, 1)) 

# Join final
stat.test_misto_final <- stat.test_misto %>% 
  # inner_join(effect_size, by = c("grupo_n", "group1", "group2")) %>% 
  mutate(grupo_n = fct_relevel(grupo_n, c(table %>% 
                                 arrange(grupo, dose) %>% 
                                 mutate(grupo_n = fct_inorder(grupo_n)) %>% 
                                 pull(grupo_n) %>% 
                                 levels()))
         )
```


```{r fig.height=4, fig.width=10}
plot_group = table %>% 
  mutate(grupo_n = str_replace_all(grupo_n, " ", "\n")) %>% 
  arrange(grupo, dose) %>% 
  mutate(
    grupo_n = fct_inorder(grupo_n)
  ) %>% 
  ggplot(aes(x = dia, y = valor_log)) +   # üîë define as escalas
  
  facet_nested_wrap(
    ~grupo_n, 
    # space  = "free_x", 
    scales = "free_x", 
    axes   = "all",
    nrow = 1
  ) +
  
   # 1. Camadas de dados: Defina o aes(x, y) dentro de cada uma
  stat_summary(aes(x = dia, y = valor_log, fill = grupo),
               geom = "crossbar", 
               fun.data = mean_cl_normal, 
               position = "dodge", 
               width=.2) +
  stat_summary(aes(x = dia, y = valor_log),
               fun = mean, 
               geom="point", 
               shape=95, 
               size=5, 
               color="black",
               stroke = 5) +
  geom_line(aes(group = animal_id),
            position = position_dodge(),
            color = "gray50",
            size = 0.5,
            alpha = 0.5) +
  geom_jitter(aes(x = dia, y = valor_log),
            color = "black",
            size = 1.5,
            stroke = 1,
            pch = 1,
            position = position_dodge()) +

  stat_pvalue_manual(
    data = stat.test_misto_final,
    label = "p.adj.signif", 
    hide.ns = TRUE,
    xmin = "xmin", 
    xmax = "xmax",
    y.position = "y.position",
    bracket.size = 0.3, 
    tip.length = 0,
    inherit.aes = FALSE
  ) +
  theme_minimal() +
  theme(text = element_text(size = 10,
                            color = "black"),
        plot.caption = element_text(size = 10, 
                                    color = "black",
                                    hjust = 0.5),
        legend.position = "top",
        legend.margin=margin(0,0,0,0),
          legend.box.margin=margin(0,0,-10,0),
          legend.text = element_text(size = 10, hjust = 0),
          legend.title = element_text(size = 10),
        axis.text.x = element_text(size = 10,
                                   hjust = 0.5,
                                   color = "black"),
        axis.text.y = element_text(size = 10,
                                   color = "black"),
        strip.text = element_text(size = 10,
                                  color = "black"),
        strip.text.y = element_text(size = 10,
                                  color = "black",
                                  angle = 0),
        axis.line.x = element_line(color = "black",
                                   size = 1),
        ggh4x.axis.nestline = element_line(linetype =1), 
        ggh4x.facet.nestline = element_line(colour = "black", linetype = 1),
        axis.line.y = element_line(color = "black",
                                   size = 1),
        axis.ticks.x = element_line(color = "black",
                                  size = 1),
        panel.grid = element_line(linetype = 2,
                                  color = "gray90")) +
  scale_fill_manual(values = c("PBS" = "white",
                             "ED-III" = "#9f9fed",
                             "QB" = "#adf7b6",
                             "Vac" = "#a9def9",
                             "Alum" = "#ff5d8f"))+
    labs(fill = "Grupo",
       color = "Grupo",
       x = "Tempo",
       y = "log10(OD50)") 

plot_group

# plot_group %>%
# ggsave(filename = here("Gr√°ficos diversos", "ELISA_OD50_ByGroup_Kruskal.png"),
#        width = 10,
#        height = 4,
#        bg = "white")
```

Unir plots
```{r fig.height=10, fig.width=12}
plot_united = (
  (plot + theme(plot.title = element_blank(),
                      plot.subtitle = element_blank())) / 
  plot_spacer() /
  (plot_group + theme(plot.title = element_blank(),
                      plot.subtitle = element_blank())) 
  )+ 
  plot_layout(guides = "collect", axes = "collect",
              heights = c(0.6, -0.05, 0.4)) +
  plot_annotation(
    theme = theme(
      legend.position = "top",
      legend.margin = margin(0, 0, 0, 0),
      legend.box.margin = margin(0, 0, -10, 0),
      legend.text = element_text(size = 10, hjust = 0),
      legend.title = element_text(size = 10),
      panel.spacing = unit(0, "lines"),
      plot.margin = margin(0, 0, 0, 0, unit = "cm"),
      plot.title = element_text(hjust = 0, margin = margin(l = 30,
                                                           b = -10)),
      plot.subtitle = element_text(hjust = 0, margin = margin(l = 30))
    ),
    title = "ELISA OD50"
  )

plot_united

plot_united %>%
ggsave(filename = here("Gr√°ficos diversos", "Evelyn", "ELISA_OD50_ByGroup_ByDay.png"),
       width = 12,
       height = 10,
       bg = "white")
```





# IgG Subclasses
```{r fig.height=5, fig.width=10}
igg_subclasses <- read_excel(here("Gr√°ficos diversos", "Evelyn", "igg_subclasses.xlsx"))


table = igg_subclasses %>% 
  drop_na() %>% 
  pivot_longer(cols = -teste,
               values_to = "valor",
               names_to = "condicao") %>% 
    clean_names() %>% 
  group_by(teste) %>%
  separate(condicao, into = c("condicao", "del"), "\\...") %>% 
  select(-del) %>% 
  ungroup() %>%
mutate(
         valor = str_replace(valor, ",", ".") %>% 
           str_replace(", ", ".") %>% 
           str_replace(". ", ".") %>% 
           as.numeric(),
         valor_log = log10(valor + 1),
         
         condicao = str_replace(condicao, "ug", "Œºg"), #Trocar unidade
         condicao = str_replace(condicao, " Œºg", "Œºg"), #Trocar unidade
         ) %>% 
  mutate(condicao = str_replace(condicao, pattern = "Vacina Alum ", "Alum "),
         condicao = str_replace(condicao, pattern = "Vacina ", "Vac "),
         condicao = str_remove(condicao, pattern = "Prote√≠na "),
         #Definir grupos, sem a dose
         grupo = case_when(str_detect(condicao, "Vac") ~ "Vac",
                           str_detect(condicao, "PBS") ~ "PBS",
                           str_detect(condicao, "QB") ~ "QB",
                           str_detect(condicao, "ED-III") ~ "ED-III",
                           str_detect(condicao, "Alum") ~ "Alum",
                           T ~ condicao),
         grupo = fct_relevel(grupo, 
                             "PBS", 
                             "QB",
                             "ED-III",
                             "Vac",
                             "Alum"
                             ),
         #Extrair e reordenar dose
         dose = str_remove_all(condicao, "Alum |PBS |Vac |ED-III "),
         #Reordenar fatores
         dose = fct_relevel(dose, 
                             "PBS",
                              "QB",
                             "10Œºg",
                             "25Œºg",
                             "50Œºg")) %>% 
  #Add summary statistics
  group_by(teste, grupo, dose) %>% 
  mutate(n = n()) %>% 
  ungroup() %>% 
  mutate(grupo_n = paste0(condicao, " n=", n),
         dose_n = paste0(dose, "\nn=", n),
         experimento = "1-2-3") %>% 
  arrange(grupo, dose) %>% 
  mutate(dose_n = fct_inorder(dose_n))

table

```





## ANOVA e posthoc
### Teste de normalidade
```{r fig.height=5, fig.width=5}
#Teste de Shapiro-Wilk
## p<0.05: N√£o-normal
## p>0.05: Normal
table %>% 
  filter(!grupo %in% c("QB", "PBS")) %>% 
  group_by(grupo) %>% 
  shapiro_test(valor_log) %>% 
  mutate(normal = ifelse(p > 0.05, "Yes", "No"))


# Q-Q Plot
qq_plot = table %>% 
  arrange(grupo_n) %>% 
  mutate(condicao = fct_inorder(condicao)) %>% 
ggplot(aes(sample = valor_log,
           color = grupo)) +
  scale_x_continuous(expand = c(0.1,0.1), 
                     n.breaks = 3
                     ) +  
  scale_y_continuous(expand = c(0.1,0.1), 
                     n.breaks = 3
                     ) + 
  stat_qq() +
  stat_qq_line() +
  facet_grid(~condicao~teste, 
               scales = "free",
             axes = "all",
             axis.labels = "margins") +
  theme_minimal() +
  scale_color_manual(values = c("PBS" = "white",
                             "ED-III" = "#9f9fed",
                             "QB" = "#adf7b6",
                             "Vac" = "#a9def9",
                             "Alum" = "#ff5d8f"))+
    theme(text = element_text(size = 10,
                            color = "black"),
        plot.caption = element_text(size = 10, 
                                    color = "black",
                                    hjust = 0.5),
        legend.position = "none",
        panel.spacing.x = unit(0, "lines"),
        plot.margin = margin(0, 0.3, 0, 0, unit = "cm"),
        axis.text.x = element_text(angle = 0,
                                   size = 10,
                                   color = "black"),
        axis.text.y = element_text(size = 10,
                                   color = "black"),
        strip.text = element_text(size = 10,
                                  color = "black"),
        strip.text.y = element_text(size = 10, hjust = 0, vjust = 0.5, angle = 0),
        axis.line = element_line(color = "black",
                                   size = 0.5),
        axis.ticks = element_line(color = "black",
                                  size = 0.5),
        panel.grid = element_line(linetype = 2,
                                  color = "gray90"),
        ggh4x.facet.nestline = element_line(colour = "black", linetype = 1)) +
  labs(x = "",
       y = "",
       title = "Q-Q Plot - Teste de normalidade")



qq_plot

qq_plot %>%
ggsave(filename = here("Gr√°ficos diversos", "Evelyn", "ELISA_OD50_IgG_subtypes_qqplot.png"),
       width = 5,
       height = 5,
       bg = "white")


```
### Por dia

#### Teste de diferen√ßas
```{r fig.height=8, fig.width=12}
library(rstatix) 
anova_summary <- table %>%
 # filter(!grupo %in% c("QB", "PBS")) %>% 
  group_by(teste) %>%
  welch_anova_test(valor_log ~ grupo_n)

stat.test_dia = table %>% 
  filter(!grupo %in% c("QB", "PBS")) %>%
    mutate(grupo_n = str_replace_all(grupo_n, " ", "\n"),
         grupo_n = str_replace_all(grupo_n, " ", "\n"),) %>% 
  group_by(teste) %>%
  games_howell_test(valor_log ~ grupo_n, 
            detailed = T) %>% 
  group_by(teste) %>%
  add_xy_position(x = "grupo_n", step.increase = 0, scales = "free_y") %>% 
  ungroup() %>% 
  mutate(p.adj.signif = case_when(
      p.adj <= 0.01 ~ "***",       # p <= 0.01
      p.adj <= 0.05 ~ "**",        # 0.01 < p <= 0.05
      p.adj <= 0.10 ~ "*",         # 0.05 < p <= 0.10
      TRUE ~ "ns"                        # p > 0.10
    )
  ) %>% 
  group_by(teste) %>% 
  mutate(
    xmin = group1,
    xmax = group2,
    y.position = max(table$valor_log, na.rm = TRUE) + 0.2 ) %>%
  ungroup() 
    # filter(!p.adj.signif %in% c("ns")) %>% 
    # mutate(y.position = min(y.position) + (row_number() - 1) * 0.1) 


# 2. Calcular Effect Size 
effect_size <- table %>%
  filter(!grupo %in% c("QB", "PBS")) %>% 
    mutate(grupo_n = str_replace_all(grupo_n, " ", "\n"),
         grupo_n = str_replace_all(grupo_n, " ", "\n"),) %>% 
  group_by(teste) %>%
  cohens_d(valor_log ~ grupo_n, var.equal = FALSE) %>% 
  mutate(effsize = round(effsize, 1))

# Join final
stat.test<- stat.test_dia %>% 
  inner_join(effect_size, by = c("teste", "group1", "group2"))
```


```{r fig.height=5, fig.width=10}
plot = table %>% 
  mutate(grupo_n = str_replace_all(grupo_n, " ", "\n")) %>% 
  arrange(grupo, dose) %>% 
  mutate(grupo_n = fct_inorder(grupo_n)) %>% 
  ggplot() +
  aes(x = grupo_n,
      y = valor_log) +
    facet_grid(~teste,
             space = "free_x",
             scales = "free_x",
             axes = "all",
             ) +
  stat_summary(aes(fill = grupo),
               geom = "crossbar", fun.data = mean_cl_normal, position = "dodge", width=.2)+
  stat_summary(fun.y= mean, 
               geom="point", 
               shape=95, 
               size=3, 
               color="red",
               stroke = 5,
               # fill="red", 
               alpha = 1,
               show.legend = F) +
  stat_summary(fun.y= mean, 
               geom="point", 
               shape=95, 
               size=5, 
               color="black",
               stroke = 5,
               alpha = 1,
               show.legend = F) +
  geom_sina(color = "black",
              size = 1.5, #or geom_jitter(position = position_dodge(width = 0.1))
             stroke = 1,
             pch = 1,
             alpha = 1) +
  stat_pvalue_manual(data = stat.test,
    label = "p.adj.signif", 
    hide.ns = TRUE, 
    bracket.size = 0.3, 
    tip.length = 0.0,
    step.increase = 0.05,
    # vjust = 0.7
  ) +

# geom_violin(color = "gray10",
  #             fill = NA,
  #             alpha = 1, 
  #             width = 1) +
  # geom_boxplot(outlier.shape = NA,
  #              alpha = 1, 
  #              width = 0.5) +
  
  theme_minimal() +
  theme(text = element_text(size = 10,
                            color = "black"),
        plot.caption = element_text(size = 10, 
                                    color = "black",
                                    hjust = 0.5),
        legend.position = "top",
        legend.margin=margin(0,0,0,0),
          legend.box.margin=margin(0,0,-10,0),
          legend.text = element_text(size = 10, hjust = 0),
          legend.title = element_text(size = 10),
        axis.text.x = element_text(size = 10,
                                   hjust = 0.5,
                                   color = "black"),
        axis.text.y = element_text(size = 10,
                                   color = "black"),
        strip.text = element_text(size = 10,
                                  color = "black"),
        strip.text.y = element_text(size = 10,
                                  color = "black",
                                  angle = 0),
        axis.line.x = element_line(color = "black",
                                   size = 1),
        ggh4x.axis.nestline = element_line(linetype =1), 
        ggh4x.facet.nestline = element_line(colour = "black", linetype = 1),
        axis.line.y = element_line(color = "black",
                                   size = 1),
        axis.ticks.x = element_line(color = "black",
                                  size = 1),
        panel.grid = element_line(linetype = 2,
                                  color = "gray90")) +
  
  # # scale_y_continuous(transform = "log10", 
  # #                    labels = scales::label_log(base = 10),
  # #                    breaks = scales::breaks_log(n = 6)) +
  # annotation_logticks(sides = "l") +
  scale_fill_manual(values = c("PBS" = "white",
                             "ED-III" = "#9f9fed",
                             "QB" = "#adf7b6",
                             "Vac" = "#a9def9",
                             "Alum" = "#ff5d8f"))+
    labs(fill = "Grupo",
       color = "Grupo",
       x = "",
       y = "Log10(OD50)",
       title = "ELISA OD50% IgG subtypes - All vs. All ") 

plot

plot %>%
ggsave(filename = here("Gr√°ficos diversos", "Evelyn", "ELISA_OD50_IgG_ByGroup_Welch.png"),
       width = 10,
       height = 4,
       bg = "white")

```




# Bootstrapping

## Reamostragem por grupo
```{r fig.height=5, fig.width=10}
library(rsample)
table

# Dados ELISA OD50 (Tabela larga)

# Gerar bootstrap para cada grupo separadamente
bootstrap_means <-  table %>% 
  unite(group_dia, c(group, dia), sep = "_") %>% 
  group_split(group_dia) %>%                       # Dividir os dados por grupo
  map_dfr(~ {
    group_name <- unique(.x$group_dia)             # Pegar o nome do grupo
    boot_data <- bootstraps(.x, times = 10000)  # Gerar bootstraps para o grupo
    
    # Calcular a m√©dia de cada amostra bootstrap
    boot_data %>%
      mutate(
        group_dia = group_name,                               # Adicionar o nome do grupo
        mean_value = map_dbl(splits, ~ mean(analysis(.x)$value))
      )
  })
```

Visualizando
```{r fig.height=10, fig.width=5}
library(ggridges)
bootstrap_means %>% 
         separate(group_dia, into = c("group", "dia"), sep = "_", remove = F) %>%  
       mutate(group = fct_relevel(group, table$group %>% unique() %>% as.character())) %>% 
ggplot(
       aes(x = mean_value,
           y = group,
           group = group_dia,
           fill = group)) +
  geom_density_ridges()+
  # geom_density_ridges(jittered_points = TRUE,
  #                     stat = "binline",
  #   position = position_points_jitter(width = 0.05, height = 0), 
  #   point_shape = '.', point_size = 3, point_alpha = 1, alpha = 1,
  #   scale = 1) +
  
  labs(title = "M√©dias de reamostragens por Bootstrap, IC 95%",
       x = "Frequency",
       y = "Mean") +
  facet_wrap(~dia, 
             scales = "free",
             ncol = 1) +
  theme_minimal() +
  theme(axis.line.x = element_line(size = 1))
```

## IC
```{r}
# Intervalos de confian√ßa
# Calcular IC 95% por grupo
ci_results <- bootstrap_means %>%
  group_by(group_dia) %>%
  summarise(
    lower_ci = quantile(mean_value, 0.025),  # Percentil 2.5%
    upper_ci = quantile(mean_value, 0.975),  # Percentil 97.5%
    mean_bootstrap = mean(mean_value)        # M√©dia das reamostras
  ) %>% 
  separate(group_dia, into = c("group", "dia"), sep = "_") %>% 
         mutate(group = fct_relevel(group, table$group %>% unique() %>% as.character()))
bootstrap_means
ci_results


ggplot(ci_results, aes(x = group, y = mean_bootstrap)) +
  geom_point(size = 3, color = "red") +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = 0) +
  labs(title = "M√©dias de reamostragens por Bootstrap, IC 95%",
       x = "Grupo",
       y = "M√©dia") +
  facet_wrap(~dia, scales = "free", nrow = 1) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1),
        axis.line.x = element_line(size = 1))

```

## Bootstrap de diferen√ßas
```{r}
trt_10 = bootstrap_means %>% 
    separate(group_dia, into = c("group", "dia"), sep = "_") %>% 
    mutate(group = fct_relevel(group, table$group %>% unique() %>% as.character())) %>% 
  filter(group == "Alum 10 Œºg",
         dia == "35") %>% 
  pull(mean_value)

ctrl = bootstrap_means %>% 
    separate(group_dia, into = c("group", "dia"), sep = "_") %>% 
    mutate(group = fct_relevel(group, table$group %>% unique() %>% as.character())) %>% 
  filter(group == "PBS",
         dia == "35") %>% 
  pull(mean_value)

# p-valor baseado na hip√≥tese nula
p_value_null <- mean(abs(bootstrap_diff_null) >= 0)


obs_diff = mean(trt_10) - mean(ctrl)
bootstrap_diff = trt_10 - ctrl
bootstrap_diff_null <- bootstrap_diff - obs_diff
ci <- quantile(bootstrap_diff, probs = c(0.025, 0.975))
mean_diff <- mean(bootstrap_diff)
diff_observed <- mean(trt_10) - mean(ctrl)
bootstrap_null <- bootstrap_diff - mean(bootstrap_diff) # Recentrar a distribui√ß√£o bootstrapada para a hipotese nula
p_value_null <- mean(abs(bootstrap_null) >= abs(diff_observed)) #O valor p √© a propor√ß√£o de valores do bootstrap maiores ou menores que a diferen√ßa observada

diff_bootstrap_results <- tibble(
  mean_diff = mean_diff,
  lower_ci = ci[1],
  upper_ci = ci[2],
  p_value = p_value_null
)

ggplot(diff_bootstrap_results, aes(x = "", y = mean_diff)) +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = 0) +
  geom_point(size = 3, color = "red") +
  labs(title = "Bootstrap of mean differences (n = 1000), IC 95%",
       subtitle = paste0("pvalue = ", diff_bootstrap_results$p_value), 
       x = "Group",
       y = "Mean differences") +
  # scale_y_continuous(limits = c(0, 700), breaks = seq(0, 700, 100))+
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1),
        axis.line.x = element_line(size = 1),
        panel.grid = element_line(color = "gray75",
                                  linetype = 2)) +
  geom_hline(yintercept = 0, color = "black",
             linetype = 2) 



```




